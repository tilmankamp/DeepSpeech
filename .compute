#!/bin/bash

set -xe

apt-get install -y python3-venv
python3 -m venv /tmp/venv
source /tmp/venv/bin/activate

pip install -r <(grep -v tensorflow requirements.txt)
pip install tensorflow-gpu==1.13.1

# Install ds_ctcdecoder package from TaskCluster
pip install $(python3 util/taskcluster.py --decoder)

mkdir -p ../keep/summaries

data="${ML_GROUP_DIR}/ds/training/augmented"

training_phase() {
    aug="$1"; shift
    python -u DeepSpeech.py \
        --noshow_progressbar \
        --load auto \
        --train_files "${data}/ds_train_${aug}.csv" \
        --train_cached_features_path "${data}/ds_train_${aug}.bundle" \
        --train_batch_size 24 \
        --dev_files "${data}/ds_dev_${aug}.csv" \
        --dev_cached_features_path "${data}/ds_dev_${aug}.bundle" \
        --dev_batch_size 48 \
        --test_files "${data}/ds_test_${aug}.csv" \
        --test_cached_features_path "${data}/ds_test_${aug}.bundle" \
        --test_batch_size 48 \
        --learning_rate 0.0001 \
        --dropout_rate 0.15 \
        --epochs 50 \
        --max_to_keep 1 \
        --checkpoint_dir "../keep" \
        --summary_dir "../keep/summaries" \
        "$@"
    phase_dir="../keep/best_${aug}"
    mkdir -p "${phase_dir}"
    cp ../keep/best_dev* "${phase_dir}"
}

training_phase clean
training_phase noise1 --load best
training_phase noise2 --load best
