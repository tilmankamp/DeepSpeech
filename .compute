#!/bin/bash

set -x

apt-get install -y python3-venv ffmpeg libavcodec-extra
python3 -m venv /tmp/venv
source /tmp/venv/bin/activate

pip install -r <(grep -v tensorflow requirements.txt)
pip install tensorflow-gpu==1.13.1

# Install ds_ctcdecoder package from TaskCluster
pip install $(python3 util/taskcluster.py --decoder)

while true; do
	python -u transcribe.py \
  		--src "${SHARED_DIR}/data/NPR/WAMU" \
  		--dst "${ML_GROUP_DIR}/transcriptions/NPR/WAMU" \
  		--formats .mp3 \
  		--batch_size 100 \
  		--outlier_fraction 0.1 \
  		--outlier_batch_size 10 \
  		--checkpoint_dir "../keep"
	if [ $? -eq 0 ]; then
        	break
	fi
done
