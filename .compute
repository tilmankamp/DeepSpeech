#!/bin/bash

set -xe

apt-get install -y python3-venv libopus0 libsndfile1-dev

python3 -m venv /tmp/venv
source /tmp/venv/bin/activate

pip install -U setuptools wheel pip
pip install .
pip uninstall -y tensorflow
pip install tensorflow-gpu==1.14

mkdir -p ../keep/summaries

data="${SHARED_DIR}/data"
swc="${data}/UHH/SWC/german-"
tuda="${data}/UHH/TUDA/tuda-v2-"
mlabs="${data}/Caito/M-AILABS/de_DE/de_DE_"
cv="${data}/mozilla/CommonVoice/de_538h_2019-12-10/"

python -u DeepSpeech.py \
  --alphabet_config_path "${ML_GROUP_DIR}/language-models/de/alphabet.txt" \
  --scorer "${ML_GROUP_DIR}/language-models/de/tmp.scorer" \
  --train_files "${swc}train.sdb,${tuda}train.sdb,${mlabs}train.sdb,${cv}train.sdb" \
  --dev_files "${cv}dev.sdb"\
  --test_files "${cv}test.sdb" \
  --train_batch_size 12 \
  --dev_batch_size 12 \
  --test_batch_size 12 \
  --train_cudnn \
  --n_hidden 2048 \
  --learning_rate 0.0001 \
  --reduce_lr_on_plateau \
  --plateau_epochs 5 \
  --plateau_reduction 0.2 \
  --dropout_rate 0.40 \
  --epochs 150 \
  --noearly_stop \
  --augment pitch[pitch=1.0~0.1] \
  --augment tempo[factor=1.0~0.1] \
  --cache_for_epochs 4 \
  --feature_cache "../tmp/feature.cache" \
  --checkpoint_dir "../keep" \
  --summary_dir "../keep/summaries"
